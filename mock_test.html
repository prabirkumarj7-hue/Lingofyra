<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Test | Lingofyra</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Playfair+Display:wght@700&family=Quicksand:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="database.js"></script>
    <script src="theme-manager.js"></script>
    <script>
        // Gatekeeper: Check for active session before rendering
        if (!localStorage.getItem('lingofyra_user')) {
            window.location.href = 'login.html?redirect=mock_test.html';
        }
    </script>
    <style>
        .test-wrapper {
            max-width: 800px;
            margin: 50px auto;
            padding: 0 20px;
        }

        .test-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .test-header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff79c6, #bd93f9);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stage-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stage-badge {
            padding: 8px 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
            color: var(--text-muted);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: 0.3s;
        }

        .stage-badge.active {
            background: rgba(255, 121, 198, 0.2);
            color: #ff79c6;
            border-color: #ff79c6;
            transform: scale(1.1);
        }

        .stage-badge.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .quiz-container {
            position: relative;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 40px;
            min-height: 400px;
        }

        .question-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .question-text {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .options-grid {
            display: grid;
            gap: 15px;
        }

        .option-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .option-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #ff79c6;
            transform: translateX(5px);
        }

        .option-card.correct {
            background: rgba(80, 250, 123, 0.1);
            border-color: #50fa7b;
        }

        .option-card.wrong {
            background: rgba(255, 85, 85, 0.1);
            border-color: #ff5555;
        }

        .btn-next {
            margin-top: 30px;
            width: 100%;
            display: none;
        }

        .score-display {
            text-align: center;
            display: none;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 8px solid #ff79c6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #ff79c6, #bd93f9);
            width: 0%;
            transition: 0.5s;
        }
    </style>
</head>

<body>
    <div class="background-blobs">
        <div class="blob blob-1" style="background: rgba(255, 121, 198, 0.2);"></div>
        <div class="blob blob-2" style="background: rgba(189, 147, 249, 0.2);"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="test-wrapper">
        <div class="back-nav" style="display: flex; gap: 15px; align-items: center;">
            <a href="index.html" class="btn-back">
                <span class="material-icons-round">arrow_back</span> Back to Home
            </a>
            <button class="btn-theme-toggle" onclick="toggleTheme()" style="margin: 0;">
                <span class="material-icons-round theme-toggle-icon">dark_mode</span>
            </button>
        </div>

        <header class="test-header">
            <h1>AI Mock Test üéØ</h1>
            <p>Master English stage by stage.</p>
        </header>

        <div class="stage-indicator">
            <div id="badge-simple" class="stage-badge active">Stage 1: Simple</div>
            <div id="badge-medium" class="stage-badge locked">Stage 2: Medium</div>
            <div id="badge-hard" class="stage-badge locked">Stage 3: Hard</div>
        </div>

        <div id="quiz-box" class="quiz-container">
            <div class="progress-bar">
                <div id="progress" class="progress-fill"></div>
            </div>

            <div id="question-view">
                <div class="question-meta">
                    <span id="question-count">Question 1 of 5</span>
                    <span id="category-label">Grammar</span>
                </div>
                <div id="question-text" class="question-text">
                    Loading question...
                </div>
                <div id="options-grid" class="options-grid">
                    <!-- Options -->
                </div>
                <button id="next-btn" class="btn-primary btn-next">Next Question</button>
            </div>

            <div id="result-view" class="score-display">
                <div class="score-circle">
                    <span id="final-score" class="score-val">0</span>
                    <span id="max-possible">Out of 5</span>
                </div>
                <h2 id="result-message">Stage Complete!</h2>
                <p id="result-desc" style="color: var(--text-muted); margin-bottom: 30px;">Feedback loading...</p>
                <div id="result-actions">
                    <!-- Buttons will change based on passing/failing -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Certificate Template (Off-screen) -->
    <div id="certificate-template" style="position: fixed; left: -9999px; top: 0; z-index: -1;">
        <div
            style="width: 800px; height: 600px; padding: 50px; text-align: center; border: 10px solid #4f46e5; background: #fff; color: #333; font-family: 'Playfair Display', serif; position: relative;">
            <div style="width: 100%; height: 100%; border: 2px solid #4f46e5; padding: 40px; box-sizing: border-box;">
                <h1 style="font-size: 3.5rem; margin-bottom: 10px; color: #1e293b;">Certificate of Completion</h1>
                <p style="font-size: 1.2rem; color: #64748b; margin-bottom: 40px;">This certifies that</p>
                <h2 id="cert-name"
                    style="font-size: 2.5rem; border-bottom: 2px solid #ccc; display: inline-block; padding: 0 40px 10px; margin-bottom: 20px; color: #000;">
                    [User Name]</h2>
                <p style="font-size: 1.2rem; margin-bottom: 40px;">has successfully mastered English Proficiency at the
                    <strong>Expert Level</strong>
                </p>
                <div style="display: flex; justify-content: space-around; margin-top: 60px;">
                    <div style="text-align: center;">
                        <p id="cert-date"
                            style="font-size: 1.1rem; font-weight: bold; border-top: 1px solid #333; padding-top: 10px; width: 200px; margin: 0 auto;">
                            Date</p>
                    </div>
                    <div style="text-align: center;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Signature_sample.svg"
                            style="height: 40px; margin-bottom: -15px; opacity: 0.7;">
                        <p
                            style="font-size: 1.1rem; font-weight: bold; border-top: 1px solid #333; padding-top: 10px; width: 200px; margin: 0 auto;">
                            Lingofyra Director</p>
                    </div>
                </div>
                <div style="position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center;">
                    <span class="material-icons-round" style="font-size: 3rem; color: #ffd700;">verified</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="database.js"></script>
    <script>
        const stages = {
            simple: [
                { q: "What is the opposite of 'Big'?", options: ["Small", "Large", "High", "Long"], correct: 0, cat: "Vocabulary" },
                { q: "She ___ playing with her toys.", options: ["am", "is", "are", "be"], correct: 1, cat: "Grammar" },
                { q: "Which one is a fruit?", options: ["Potato", "Apple", "Onion", "Carrot"], correct: 1, cat: "General" },
                { q: "Past tense of 'Run' is:", options: ["Runned", "Running", "Ran", "Runs"], correct: 2, cat: "Verbs" },
                { q: "Correct spelling of 'Apple' is:", options: ["Apel", "Aple", "Apple", "Appel"], correct: 2, cat: "Spelling" },
                { q: "What is the opposite of 'Happy'?", options: ["Angry", "Sad", "Joyful", "Excited"], correct: 1, cat: "Vocabulary" },
                { q: "I ___ a student.", options: ["am", "is", "are", "be"], correct: 0, cat: "Grammar" },
                { q: "Which color is a primary color?", options: ["Green", "Red", "Purple", "Orange"], correct: 1, cat: "General" },
                { q: "A ___ bark at night.", options: ["Cat", "Dog", "Bird", "Fish"], correct: 1, cat: "Vocabulary" },
                { q: "Plural of 'Box' is:", options: ["Boxs", "Boxen", "Boxies", "Boxes"], correct: 3, cat: "Grammar" },
                { q: "Which one is an animal?", options: ["Table", "Chair", "Lion", "Pen"], correct: 2, cat: "General" },
                { q: "Opposite of 'Fast' is:", options: ["Quick", "Slow", "High", "Low"], correct: 1, cat: "Vocabulary" },
                { q: "He ___ a big car.", options: ["have", "has", "is", "are"], correct: 1, cat: "Grammar" },
                { q: "We eat with our ___.", options: ["Eyes", "Ears", "Mouth", "Nose"], correct: 2, cat: "General" },
                { q: "The sky is ___.", options: ["Green", "Blue", "Yellow", "Red"], correct: 1, cat: "General" }
            ],
            medium: [
                { q: "They have ___ all the cookies.", options: ["eat", "ate", "eaten", "eating"], correct: 2, cat: "Tenses" },
                { q: "I haven't seen him ___ last year.", options: ["for", "since", "from", "during"], correct: 1, cat: "Prepositions" },
                { q: "A person who treats teeth is a:", options: ["Doctor", "Dentist", "Farmer", "Pilot"], correct: 1, cat: "Vocabulary" },
                { q: "If it rains, I ___ stay at home.", options: ["will", "would", "shall", "can"], correct: 0, cat: "Conditionals" },
                { q: "Which one is an Adverb?", options: ["Beautiful", "Quickly", "Fast", "Smart"], correct: 1, cat: "Parts of Speech" },
                { q: "You should avoid ___ too much coffee.", options: ["drink", "to drink", "drinking", "drunk"], correct: 2, cat: "Gerunds" },
                { q: "She is the ___ student in the class.", options: ["smart", "smarter", "smartest", "most smart"], correct: 2, cat: "Superlatives" },
                { q: "We ___ breakfast when the phone rang.", options: ["have", "were having", "had", "are having"], correct: 1, cat: "Past Continuous" },
                { q: "He ___ to the gym every morning.", options: ["go", "goes", "going", "gone"], correct: 1, cat: "Present Simple" },
                { q: "If I ___ you, I would take that job.", options: ["am", "was", "were", "be"], correct: 2, cat: "Conditionals" },
                { q: "They ___ for two hours before it started raining.", options: ["walked", "have walked", "had been walking", "were walking"], correct: 2, cat: "Tenses" },
                { q: "An 'Optician' is someone who fixes ___.", options: ["Teeth", "Eyes/Glasses", "Cars", "Shoes"], correct: 1, cat: "Occupations" },
                { q: "Which is a synonym for 'Huge'?", options: ["Tiny", "Massive", "Small", "Weak"], correct: 1, cat: "Vocabulary" },
                { q: "I am interested ___ learning Japanese.", options: ["in", "at", "on", "for"], correct: 0, cat: "Prepositions" },
                { q: "Neither of the boys ___ there.", options: ["was", "were", "are", "have been"], correct: 0, cat: "Grammar" },
                { q: "Success depends ___ hard work.", options: ["in", "on", "at", "for"], correct: 1, cat: "Prepositions" },
                { q: "The movie was so ___ that I fell asleep.", options: ["boring", "bored", "bore", "bores"], correct: 0, cat: "Adjectives" },
                { q: "He speaks English ___ well.", options: ["very", "too", "much", "more"], correct: 0, cat: "Adverbs" },
                { q: "It's time we ___.", options: ["leave", "left", "leaving", "to leave"], correct: 1, cat: "Subjunctive" },
                { q: "She is afraid ___ spiders.", options: ["of", "from", "with", "at"], correct: 0, cat: "Prepositions" }
            ],
            hard: [
                { q: "The book was written ___ an unknown author.", options: ["by", "with", "from", "at"], correct: 0, cat: "Passive Voice" },
                { q: "I wish I ___ a billionaire.", options: ["am", "was", "were", "been"], correct: 2, cat: "Wishful Thinking" },
                { q: "He is not only smart ___ also kind.", options: ["and", "but", "though", "or"], correct: 1, cat: "Conjunctions" },
                { q: "The idiom 'A piece of cake' means:", options: ["Eating food", "Very easy", "Birthday party", "Difficult task"], correct: 1, cat: "Idioms" },
                { q: "By next year, I ___ my degree.", options: ["will finish", "will have finished", "finish", "am finishing"], correct: 1, cat: "Future Perfect" },
                { q: "Notwithstanding the rain, the event proceeded. Synonym of 'Notwithstanding':", options: ["Despite", "Because of", "Instead of", "Rather than"], correct: 0, cat: "Prepositions" },
                { q: "The suspect ___ out of the building before the police arrived.", options: ["was running", "had run", "has run", "ran"], correct: 1, cat: "Past Perfect" },
                { q: "Hardly ___ entered the room when the lights went out.", options: ["I had", "had I", "I have", "have I"], correct: 1, cat: "Inversion" },
                { q: "It is essential that he ___ on time.", options: ["is", "be", "was", "will be"], correct: 1, cat: "Subjunctive" },
                { q: "The older I get, ___ I become.", options: ["the wise", "wiser", "the wiser", "wisest"], correct: 2, cat: "Comparatives" },
                { q: "I would rather you ___ here tonight.", options: ["stay", "stayed", "to stay", "staying"], correct: 1, cat: "Subjunctive" },
                { q: "She acted as though she ___ the boss.", options: ["is", "was", "were", "be"], correct: 2, cat: "Conditionals" },
                { q: "Rarely ___ such a beautiful sunset.", options: ["we see", "did we see", "do we see", "have we seen"], correct: 3, cat: "Inversion" },
                { q: "The report ___ by next Monday.", options: ["will submit", "will be submitted", "is submitting", "submits"], correct: 1, cat: "Passive Voice" },
                { q: "I remember ___ her at the party last year.", options: ["meet", "to meet", "meeting", "met"], correct: 2, cat: "Gerunds" },
                { q: "To 'make ends meet' means:", options: ["To finish a task", "To satisfy both sides", "To earn enough money", "To join two cables"], correct: 2, cat: "Idioms" },
                { q: "The word 'Lest' is often used to express:", options: ["Permission", "Fear of something happening", "Addition", "Contrast"], correct: 1, cat: "Conjunctions" },
                { q: "The word 'Acquiesce' means:", options: ["To argue", "To accept reluctantly", "To request", "To deny"], correct: 1, cat: "Vocabulary" },
                { q: "He regretted ___ so much money on the car.", options: ["spend", "spent", "spending", "to spend"], correct: 2, cat: "Gerunds" },
                { q: "Had I known about the party, I ___.", options: ["would go", "will go", "would have gone", "went"], correct: 2, cat: "Conditionals" },
                { q: "The 'Enigmatic' nature of the artifact baffled experts. Synonym:", options: ["Clear", "Mysterious", "Ancient", "Heavy"], correct: 1, cat: "Vocabulary" },
                { q: "Only in this way ___ to succeed.", options: ["can we hope", "we can hope", "we hope", "hope we"], correct: 0, cat: "Inversion" },
                { q: "He is likely ___ the prize.", options: ["of winning", "to win", "win", "for winning"], correct: 1, cat: "Expressions" },
                { q: "___ had I started the work when the phone rang.", options: ["No sooner", "Scarcely", "Hardly", "All of above"], correct: 3, cat: "Conjunctions" },
                { q: "The proposal ___ discussed when the meeting was adjourned.", options: ["is being", "was being", "has been", "had been"], correct: 1, cat: "Passive/Continuous" },
                { q: "I'd rather you ___ tell anyone about this.", options: ["not to", "didn't", "don't", "mustn't"], correct: 1, cat: "Subjunctive" },
                { q: "To 'Put up with' means:", options: ["To carry", "To tolerate", "To postpone", "To support"], correct: 1, cat: "Phrasal Verbs" },
                { q: "Scarcely any of the students ___ passed.", options: ["has", "have", "is", "are"], correct: 1, cat: "Subject-Verb Agreement" },
                { q: "He talkes as if he ___ everything.", options: ["know", "knows", "knew", "had known"], correct: 2, cat: "Conditionals" },
                { q: "By the time we reach the station, the train ___.", options: ["will leave", "is leaving", "will have left", "left"], correct: 2, cat: "Future Perfect" }
            ]
        };

        let currentStage = 'simple';
        let currentIdx = 0;
        let score = 0;
        let answered = false;
        let activeQuestions = [];
        let mistakes = [];

        const qText = document.getElementById('question-text');
        const optionsGrid = document.getElementById('options-grid');
        const qCount = document.getElementById('question-count');
        const catLabel = document.getElementById('category-label');
        const progress = document.getElementById('progress');
        const nextBtn = document.getElementById('next-btn');
        const questionView = document.getElementById('question-view');
        const resultView = document.getElementById('result-view');
        const finalScoreLabel = document.getElementById('final-score');
        const resultActions = document.getElementById('result-actions');

        function downloadCertificate() {
            if (typeof html2pdf === 'undefined') {
                alert("Error: PDF generator library not loaded. Please checking your internet connection.");
                return;
            }

            const userName = localStorage.getItem('lingofyra_user') || 'Student';
            const date = new Date().toLocaleDateString();

            document.getElementById('cert-name').textContent = userName;
            document.getElementById('cert-date').textContent = date;

            const element = document.getElementById('certificate-template');

            // Wait for any potential layout reflows (though off-screen helps)
            // Ideally we wait for images, but for now we assume they loaded since page load.

            const opt = {
                margin: 10,
                filename: `Lingofyra_Certificate_${userName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, // Enable CORS for images
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            try {
                // Use html2pdf to download
                html2pdf().set(opt).from(element).save().then(() => {
                    alert("Certificate Downloaded Successfully! üéì");
                }).catch(err => {
                    console.error("PDF Generation Error:", err);
                    alert("Failed to generate PDF. See console for details.");
                });
            } catch (e) {
                console.error("PDF Error:", e);
                alert("An unexpected error occurred while generating the PDF.");
            }
        }

        // --- SHUFFLE ENGINE ---
        function shuffle(array) {
            let m = array.length, t, i;
            while (m) {
                i = Math.floor(Math.random() * m--);
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
            return array;
        }

        function loadQuestion() {
            const current = activeQuestions[currentIdx];

            qText.textContent = current.q;
            qCount.textContent = `Question ${currentIdx + 1} of ${activeQuestions.length}`;
            catLabel.textContent = current.cat;
            progress.style.width = `${((currentIdx) / activeQuestions.length) * 100}%`;

            // Shuffle Options for dynamic challenge
            const options = current.options.map((opt, i) => ({ text: opt, originalIndex: i }));
            shuffle(options);

            optionsGrid.innerHTML = '';
            options.forEach((opt, i) => {
                const card = document.createElement('div');
                card.className = 'option-card';
                card.innerHTML = `
                    <span style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.1); font-size: 0.8rem; font-weight: 700;">${String.fromCharCode(65 + i)}</span>
                    <span>${opt.text}</span>
                `;
                card.onclick = () => selectOption(opt.originalIndex, card, current.correct);
                card.dataset.idx = opt.originalIndex;
                optionsGrid.appendChild(card);
            });

            if (currentIdx === activeQuestions.length - 1) {
                nextBtn.textContent = "See Stage Result";
            } else {
                nextBtn.textContent = "Next Question";
            }

            nextBtn.style.display = 'none';
            answered = false;
        }

        function selectOption(originalIdx, element, correctIdx) {
            if (answered) return;
            answered = true;

            const current = activeQuestions[currentIdx];

            if (originalIdx === correctIdx) {
                element.classList.add('correct');
                score++;
            } else {
                element.classList.add('wrong');

                // Track mistake
                const correctText = current.options[correctIdx];
                const wrongText = current.options[originalIdx];
                mistakes.push({
                    q: current.q,
                    wrong: wrongText,
                    correct: correctText
                });

                // Find and highlight correct answer
                const cards = optionsGrid.children;
                for (let card of cards) {
                    if (parseInt(card.dataset.idx) === correctIdx) {
                        card.classList.add('correct');
                        break;
                    }
                }
            }

            nextBtn.style.display = 'block';
        }

        nextBtn.onclick = () => {
            currentIdx++;
            if (currentIdx < activeQuestions.length) {
                loadQuestion();
            } else {
                showStageResult();
            }
        };

        function showStageResult() {
            questionView.style.display = 'none';
            resultView.style.display = 'block';
            progress.style.width = '100%';
            finalScoreLabel.textContent = score;

            const msg = document.getElementById('result-message');
            const desc = document.getElementById('result-desc');
            const dataLength = activeQuestions.length;

            document.getElementById('max-possible').textContent = `Out of ${dataLength}`;
            resultActions.innerHTML = '';

            // --- ALWAYS ALLOW PROGRESSION (User Request) ---
            msg.textContent = score === dataLength ? "Perfect Score! üåü" : "Stage Complete! üëç";

            if (mistakes.length > 0) {
                desc.innerHTML = `<span style="color: #ff5555;">You got ${mistakes.length} incorrect answers.</span><br>Review below before moving on:`;

                // Render Mistakes Summary
                const summaryDiv = document.createElement('div');
                summaryDiv.style.marginTop = '20px';
                summaryDiv.style.textAlign = 'left';
                summaryDiv.style.background = 'rgba(0,0,0,0.2)';
                summaryDiv.style.padding = '15px';
                summaryDiv.style.borderRadius = '10px';
                summaryDiv.style.maxHeight = '200px';
                summaryDiv.style.overflowY = 'auto';

                mistakes.forEach(m => {
                    const item = document.createElement('div');
                    item.style.marginBottom = '10px';
                    item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    item.style.paddingBottom = '10px';
                    item.innerHTML = `
                        <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 4px;"><strong>Q:</strong> ${m.q}</div>
                        <div style="font-size: 0.85rem; color: #ff5555;">‚ùå You chose: ${m.wrong}</div>
                        <div style="font-size: 0.85rem; color: #50fa7b;">‚úÖ Correct: ${m.correct}</div>
                    `;
                    summaryDiv.appendChild(item);
                });

                // Clear previous summary if any
                const prev = resultView.querySelector('.mistakes-summary');
                if (prev) prev.remove();

                summaryDiv.className = 'mistakes-summary';
                resultView.insertBefore(summaryDiv, resultActions);
            } else {
                desc.textContent = "Amazing! You didn't make a single mistake.";
                const prev = resultView.querySelector('.mistakes-summary');
                if (prev) prev.remove();
            }

            // Save progress anyway
            const userId = localStorage.getItem('lingofyra_user_id');
            if (userId) {
                LingofyraDB.progress.saveMockTest(userId, currentStage, score);
            }

            // Buttons for next stage or certificate
            if (currentStage === 'simple') {
                createActionButton("Continue to Medium Stage ‚ûî", () => startStage('medium'), 'btn-primary');
            } else if (currentStage === 'medium') {
                createActionButton("Continue to Hard Stage ‚ûî", () => startStage('hard'), 'btn-primary');
            } else {
                // Final Stage Done
                msg.textContent = "Course Completed! üéì";
                createActionButton("Download Certificate", () => downloadCertificate(), 'btn-primary');
                createActionButton("Restart Course", () => location.reload(), 'btn-primary');
                resultActions.lastChild.style.marginTop = "10px";
                resultActions.lastChild.style.background = "#334155";
            }
        }

        function createActionButton(text, action, className) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = className;
            btn.style.width = '100%';
            btn.onclick = action;
            resultActions.appendChild(btn);
        }

        function startStage(stage) {
            currentStage = stage;
            currentIdx = 0;
            score = 0;
            mistakes = [];

            // Determine how many questions to pick based on stage
            let count = 5;
            if (stage === 'medium') count = 10;
            if (stage === 'hard') count = 20;

            // Shuffle master pool and pick a random subset (slice)
            // This ensures DIFFERENT questions every time
            const masterPool = shuffle([...stages[stage]]);
            activeQuestions = masterPool.slice(0, count);

            // Update Badges
            document.querySelectorAll('.stage-badge').forEach(b => b.className = 'stage-badge locked');
            if (stage === 'simple') {
                document.getElementById('badge-simple').className = 'stage-badge active';
            } else if (stage === 'medium') {
                document.getElementById('badge-simple').className = 'stage-badge';
                document.getElementById('badge-medium').className = 'stage-badge active';
            } else if (stage === 'hard') {
                document.getElementById('badge-simple').className = 'stage-badge';
                document.getElementById('badge-medium').className = 'stage-badge';
                document.getElementById('badge-hard').className = 'stage-badge active';
            }

            questionView.style.display = 'block';
            resultView.style.display = 'none';
            loadQuestion();
        }

        // Initialize first stage
        startStage('simple');
    </script>
</body>

</html>